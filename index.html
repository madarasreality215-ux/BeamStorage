<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì± Beam's Media Archive ‚Äî Offline (Quality + Multi-Source)</title>
<meta name="theme-color" content="#0a0a0a">

<!-- PATCH: force background color for GitHub Pages -->
<style>
html,body{ background:#0a0a0a!important; color:#e6e6e6!important; }

/* --- DROPDOWN + WRAP PATCH --- */
.folder-header{flex-wrap:wrap;}
.folder-left{flex:1 1 auto; min-width:0; overflow:hidden;}
.folder-actions{flex-shrink:0; margin-top:4px}

.folder-menu{position:relative; display:inline-block}
.folder-menu-btn{background:transparent; border:1px solid var(--card-border); color:inherit;
  border-radius:8px; padding:4px 8px; cursor:pointer; font-size:12px}
.folder-menu-btn:hover{background:rgba(255,255,255,0.06)}
.folder-menu-content{display:none; position:absolute; right:0; background:var(--card);
  border:1px solid var(--card-border); border-radius:8px;box-shadow:var(--card-shadow);
  z-index:99; min-width:140px}
.folder-menu-content button{display:block; width:100%; text-align:left; background:transparent;
  border:none; color:inherit; padding:8px 10px; font-size:12px; cursor:pointer}
.folder-menu-content button:hover{background:var(--accent-hover); color:#fff}
.folder-menu.show .folder-menu-content{display:block}

/* --- DRAGFIX PATCH --- */
.thumb, video, img { -webkit-user-drag:none; user-drag:none; }
.vitem:active { opacity:.75; transform:scale(.98); transition:transform .1s ease; }
.vitem[draggable="true"]{cursor:grab;}
.vitem[draggable="true"]:active{cursor:grabbing; opacity:.8; transform:scale(.98); transition:transform .1s ease;}

</style>
<!-- END PATCH -->
<style>
  :root{
    --bg:#0a0a0a;--card:#1a1a1a;--text:#e6e6e6;--muted:rgba(230,230,230,0.65);
    --accent:#b30000;--accent-hover:#990000;--green:#10b981;--red:#b91c1c;
    --card-border:rgba(255,255,255,0.08);--card-shadow:0 10px 25px rgba(0,0,0,0.28);
    --radius:14px
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;background:var(--card);padding:12px 16px;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--card-border)}
  h1{margin:0;font-size:18px;font-weight:700}
  .ghost{background:transparent;border:1px solid var(--card-border);padding:10px 12px;border-radius:10px;cursor:pointer;color:#fff;transition:.25s}
  .ghost:hover{background:rgba(255,255,255,0.08)}
  .container{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;min-height:calc(100vh - 60px)}
  .card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:14px}
  .card h3{margin:0 0 10px 0;font-size:14px;color:var(--accent);display:flex;align-items:center;gap:8px}
  .sidebar{display:flex;flex-direction:column;gap:16px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;transition:.25s}
  .btn:hover{background:var(--accent-hover)}
  .btn-green{background:var(--green)}
  .input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--card-border);background:transparent;color:var(--text)}
  .small{font-size:12px;color:var(--muted)}
  .folders-empty{color:var(--muted);text-align:center;padding:10px}
  .folder-section{border:1px dashed var(--card-border);border-radius:12px;background:rgba(255,255,255,0.02);margin-top:8px}
  .folder-header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px 12px;cursor:pointer;border-radius:12px}
  .folder-left{display:flex;align-items:center;gap:8px;min-width:0}
  .folder-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .folder-actions{display:flex;gap:6px}
  .action{background:transparent;border:1px solid var(--card-border);color:inherit;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px}
  .action:hover{background:rgba(255,255,255,0.06)}
  .toggle-icon{display:inline-block;width:16px;text-align:center;opacity:.85}
  .main{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px}
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .empty{display:flex;align-items:center;justify-content:center;min-height:60vh;color:var(--muted);font-size:16px}

  /* Viewer overlay - UPDATED FOR MOBILE & SIDE BUTTONS */
  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:9999;opacity:0;transition:opacity .25s ease}
  .viewer.show{display:flex;opacity:1}
  .viewer-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;margin:0 auto;padding:0 12px;position:relative}
  #viewer .viewer-topbar{width:100% !important;max-width:100% !important;margin:0 auto 12px !important;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,0.55);color:#fff;backdrop-filter:blur(12px);position:absolute;top:16px;left:50%;transform:translateX(-50%);width:90%}
  #viewerVideo{display:block;margin:0 auto;max-width:92vw;max-height:84vh;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.45);background:#000}
  #viewerImage{display:none;margin:0 auto;max-width:92vw;max-height:84vh;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.45);object-fit:contain;background:#000}
  
  /* Side navigation buttons */
  .viewer-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.7);border:none;color:white;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:10000;transition:background .2s}
  .viewer-nav:hover{background:rgba(0,0,0,0.9)}
  #viewerPrev{left:20px}
  #viewerNext{right:20px}

  video{display:block;margin:0 auto}

  /* Toast */
  .toast{position:fixed;right:16px;bottom:80px;background:rgba(26,26,26,.95);color:#e6e6e6;padding:10px 14px;border:1px solid rgba(255,255,255,.08);border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.35);opacity:0;transform:translateY(12px);transition:opacity .25s ease,transform .25s ease;pointer-events:none;z-index:10000}
  .toast.show{opacity:1;transform:translateY(0)}

  .thumb{width:260px;height:150px;background:#000;border-radius:8px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#aaa}
  .vitem{width:260px;display:flex;flex-direction:column;text-align:center;background:rgba(255,255,255,0.04);border-radius:10px;padding:8px;cursor:pointer;transition:.2s;margin:6px}
  .vitem:hover{background:rgba(255,255,255,0.06)}
  .badge{font-size:10px;background:var(--accent);color:#fff;border-radius:999px;padding:2px 8px;margin-left:6px}
  .item-actions{display:flex;justify-content:center;gap:8px;margin-top:6px}
  .item-btn{background:transparent;border:1px solid var(--card-border);color:inherit;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px}
  .item-btn:hover{background:rgba(255,255,255,0.06)}
  .vitem h4{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all;display:block;margin:6px 0 0 0;font-size:13px;text-align:center;}

  /* Pagination */
  .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:20px;padding:10px}
  .pagination button{background:var(--card);border:1px solid var(--card-border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
  .pagination button:hover:not(:disabled){background:var(--accent-hover)}
  .pagination button:disabled{opacity:0.5;cursor:not-allowed}
  .pagination-info{font-size:14px;color:var(--muted)}

  /* Folder action buttons in topbar */
  .folder-topbar-actions{display:none;gap:8px;align-items:center}
  .folder-topbar-actions button{background:transparent;border:1px solid var(--card-border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;transition:background .2s}
  .folder-topbar-actions button:hover{background:rgba(255,255,255,0.08)}

  /* Media action buttons in topbar */
  .media-topbar-actions{display:flex;gap:8px;align-items:center}
  .media-topbar-actions button{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;transition:background .2s;font-weight:600}
  .media-topbar-actions button:hover{background:var(--accent-hover)}
  .media-topbar-actions .btn-green{background:var(--green)}
  .media-topbar-actions .btn-green:hover{background:#0da271}

  /* ======= MOBILE LAYOUT ======= */
  @media (max-width: 768px) {
    .container{ grid-template-columns:1fr; gap:12px; padding:12px; }
    body{ overflow-x:hidden; }
    header{ padding:10px 12px; }
    h1{ font-size:16px; }
    .sidebar{ order:2; }
    .main{ order:1; }
    #viewerVideo,#viewerImage{ max-width:96vw; max-height:70vh; }
    .vitem{ width:calc(50% - 12px); min-width:unset; }
    .thumb{ width:100%; height:120px; }
    .topbar{ flex-wrap:wrap; }
    .folder-topbar-actions,.media-topbar-actions{ order:2; margin-top:8px; width:100%; justify-content:center; }
    #backBtn,#backToMain{ order:1; }

    /* Fixed bottom nav on mobile */
    .mobile-nav{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(20,20,20,.98);
      border-top:1px solid var(--card-border);
      display:flex; gap:8px; justify-content:space-around; align-items:center;
      padding:10px 8px; z-index:10001; backdrop-filter:blur(10px);
    }
    .mobile-btn{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; min-width:64px; padding:8px 10px; border-radius:12px;
      border:1px solid var(--card-border); background:transparent; color:var(--text);
      font-size:12px; line-height:1.1;
    }
    .mobile-btn:active{ transform:scale(.98); }
    .mobile-fab{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:18px; padding:12px 18px; border-radius:999px; font-weight:800;
      background:var(--accent); color:#fff; border:none;
    }
    .toast{ bottom:110px; } /* keep above navbar */

    /* Bottom sheet for Add menu */
    .sheet{
      position:fixed; left:0; right:0; bottom:-400px; background:var(--card);
      border-top-left-radius:16px; border-top-right-radius:16px;
      box-shadow:0 -10px 30px rgba(0,0,0,.45); padding:14px;
      transition:bottom .25s ease; z-index:10002; border:1px solid var(--card-border);
    }
    .sheet.show{ bottom:60px; }
    .sheet h4{ margin:0 0 10px 0; color:var(--muted); font-size:13px; }
    .sheet .row{ display:flex; gap:10px; }
    .sheet .row button{ flex:1; padding:12px; border-radius:12px; border:1px solid var(--card-border); background:rgba(255,255,255,.03); color:var(--text); font-weight:700; }
    .sheet .row button:active{ transform:scale(.98); }
    .sheet .full{ width:100%; margin-top:8px; }
  }

  @media (max-width: 480px) {
    .vitem{ width:100%; }
    .pagination{ flex-wrap:wrap; }
    .folder-topbar-actions,.media-topbar-actions{ flex-wrap:wrap; }
  }
</style>
</head>
<body>
<header>
  <h1>‚ö° Beam's Media Archive</h1>
</header>

<div class="container">
  <div class="sidebar">
    <div class="card">
      <h3>üì¶ Create Folder</h3>
      <input id="newFolderName" class="input" placeholder="New folder name">
      <button id="addFolder" class="btn" style="margin-top:8px">ü¶à Add Folder</button>
    </div>

    <div class="card">
      <h3>üè† Main Library</h3>
      <div class="small breadcrumb">Viewing: <span id="viewLabel">Main Library</span></div>
      <div id="foldersEmpty" class="folders-empty">No folders yet. Create one below!</div>
      <div id="foldersContainer"></div>
    </div>

    <div class="card">
      <h3>üì§ Import / Export Files</h3>
      <button id="exportLibrary" class="btn" style="width:100%;margin-bottom:8px">‚¨áÔ∏è Export Library (.zip)</button>
      <input id="importFolderInput" type="file" webkitdirectory directory multiple style="display:none">
      <button id="importLibrary" class="btn btn-green" style="width:100%">üì¶ Import Library (unzipped folder)</button>
      <div class="small" style="margin-top:6px">
        Export creates a .zip backup. To import, first unzip it locally, then select the folder.
      </div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <button id="backBtn" class="ghost" style="display:none">‚¨ÖÔ∏è Back</button>
      <button id="backToMain" class="ghost" style="display:none">üè† Back to Main</button>
      <div class="media-topbar-actions" id="mediaTopbarActions">
        <button id="addVideosTopbar">üé• Add Videos</button>
        <button id="addPhotosTopbar" class="btn-green">üì∑ Add Photos</button>
      </div>
      <div class="folder-topbar-actions" id="folderTopbarActions">
        <button id="folderRemove">üóëÔ∏è Remove</button>
        <button id="folderRename">‚úèÔ∏è Rename</button>
        <button id="folderSubfolder">ü¶à Subfolder</button>
      </div>
    </div>
    <div id="mainEmpty" class="empty">No media yet. Add some videos or photos to get started!</div>
    <div id="mainList" style="display:none;flex-wrap:wrap;gap:12px;"></div>
    <div id="pagination" class="pagination" style="display:none;"></div>
  </div>
</div>

<!-- Viewer -->
<div id="viewer" class="viewer" aria-hidden="true">
  <div class="viewer-inner">
    <div class="viewer-topbar">
      <span id="viewerFilename" class="title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80%">üéûÔ∏è </span>
      <button id="viewerClose" class="ghost" aria-label="Close">‚ùå</button>
    </div>
    <button id="viewerPrev" class="viewer-nav" aria-label="Previous">‚èÆ</button>
    <video id="viewerVideo" playsinline controls preload="metadata"></video>
    <img id="viewerImage" alt="Image preview" />
    <button id="viewerNext" class="viewer-nav" aria-label="Next">‚è≠</button>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Hidden file inputs -->
<input id="videoInput" type="file" accept="video/*" multiple style="display:none">
<input id="photoInput" type="file" accept="image/*" multiple style="display:none">

<!-- ======= MOBILE NAV + SHEET (only visible under 768px) ======= -->
<div class="mobile-nav" id="mobileNav" style="display:none">
  <button class="mobile-btn" id="mHome" aria-label="Home">üè†<span>Home</span></button>
  <button class="mobile-btn" id="mFolders" aria-label="Folders">üóÇÔ∏è<span>Folders</span></button>
  <button class="mobile-fab" id="mAdd" aria-label="Add">Ôºã Add</button>
  <button class="mobile-btn" id="mImport" aria-label="Import">üì¶<span>Import</span></button>
  <button class="mobile-btn" id="mExport" aria-label="Export">‚¨áÔ∏è<span>Export</span></button>
</div>

<div class="sheet" id="addSheet" style="display:none">
  <h4>Quick actions</h4>
  <div class="row">
    <button id="mAddVideo">üé• Add Videos</button>
    <button id="mAddPhoto">üì∑ Add Photos</button>
  </div>
  <button class="full" id="mNewFolder">ü¶à New Folder</button>
</div>

<script>
/* =========================
   Persistent State
========================= */
const LS_KEY='mtp_meta_v5_allfeatures';
const DB_NAME='mtp_media_db';
const DB_STORE='media';
let state={folders:[],media:{},collapse:{},sort:'newest',activeFolderId:'',viewerCurrent:null, folderHistory: []};
const uid=p=>p+'_'+Date.now()+'_'+Math.random().toString(36).slice(2,9);
const save=()=>localStorage.setItem(LS_KEY,JSON.stringify(state));
const load=()=>{try{Object.assign(state,JSON.parse(localStorage.getItem(LS_KEY)||'{}'));}catch{}};
load();

/* =========================
   IndexedDB helpers
========================= */
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME,1);
    r.onupgradeneeded=e=>{e.target.result.createObjectStore(DB_STORE)};
    r.onerror=rej; r.onsuccess=e=>res(e.target.result);
  });
}
async function dbPut(id,blob){const db=await openDB();const tx=db.transaction(DB_STORE,'readwrite');tx.objectStore(DB_STORE).put(blob,id);return new Promise(r=>tx.oncomplete=r)}
async function dbGet(id){const db=await openDB();const tx=db.transaction(DB_STORE,'readonly');const req=tx.objectStore(DB_STORE).get(id);return new Promise((res,rej)=>{req.onsuccess=()=>res(req.result);req.onerror=rej})}
async function dbDel(id){const db=await openDB();const tx=db.transaction(DB_STORE,'readwrite');tx.objectStore(DB_STORE).delete(id);return new Promise(r=>tx.oncomplete=r)}

/* =========================
   DOM refs
========================= */
const foldersContainer=document.getElementById('foldersContainer');
const foldersEmpty=document.getElementById('foldersEmpty');
const newFolderName=document.getElementById('newFolderName');
const addFolderBtn=document.getElementById('addFolder');

const videoInput=document.getElementById('videoInput');
const addVideosTopbar=document.getElementById('addVideosTopbar');
const photoInput=document.getElementById('photoInput');
const addPhotosTopbar=document.getElementById('addPhotosTopbar');

const mainEmpty=document.getElementById('mainEmpty');
const mainList=document.getElementById('mainList');
const backBtn=document.getElementById('backBtn');
const backToMain=document.getElementById('backToMain');
const viewLabel=document.getElementById('viewLabel');
const paginationEl = document.getElementById('pagination');

// Folder action buttons in topbar
const folderTopbarActions = document.getElementById('folderTopbarActions');
const folderRemoveBtn = document.getElementById('folderRemove');
const folderRenameBtn = document.getElementById('folderRename');
const folderSubfolderBtn = document.getElementById('folderSubfolder');

// Media action buttons in topbar
const mediaTopbarActions = document.getElementById('mediaTopbarActions');

const viewer=document.getElementById('viewer');
const viewerVideo=document.getElementById('viewerVideo');
const viewerImage=document.getElementById('viewerImage');
const viewerFilename=document.getElementById('viewerFilename');
const viewerClose=document.getElementById('viewerClose');
const viewerPrev=document.getElementById('viewerPrev');
const viewerNext=document.getElementById('viewerNext');
const toast=document.getElementById('toast');

/* =========================
   Utils
========================= */
function sorter(){return (a,b)=>state.sort==='newest'?(b.createdAt||0)-(a.createdAt||0):(a.createdAt||0)-(b.createdAt||0)}
function buildTree(pid=''){return state.folders.filter(f=>(f.parentId||'')===(pid||'')).map(f=>({...f,children:buildTree(f.id)}));}

// UPDATED: Count only immediate subfolders for parent folders
function immediateFolderCount(id){ return state.folders.filter(f => (f.parentId||'') === id).length; }

// Count all items in folder (media + subfolders)
function folderCount(id){
  const mediaCount = Object.values(state.media).filter(m=>(m.folderId||'')===id).length;
  const folderCount = immediateFolderCount(id);
  return mediaCount + folderCount;
}

function showToast(msg,ms=2600){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),ms)}
function htmlUnescape(s){ return s.replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,'<').replace(/&gt;/g,'>'); }
function isDirectMedia(u){ return /\.(mp4|webm|mov|m4v|jpg|jpeg|png|gif)(\?.*)?$/i.test(u); }
function filenameFromUrl(u, fallback){
  try{
    const p=new URL(u);
    const last=(p.pathname.split('/').pop()||'').split('?')[0];
    return last || (fallback||'download');
  }catch{ return fallback||'download'; }
}

/* =========================
   Pagination
========================= */
let currentPage = 1;
const itemsPerPage = 20;

function renderPagination(totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) { paginationEl.style.display = 'none'; return; }
  paginationEl.style.display = 'flex';
  paginationEl.innerHTML = '';
  const prevBtn = document.createElement('button');
  prevBtn.innerHTML = '‚¨ÖÔ∏è';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderMain(); } };
  paginationEl.appendChild(prevBtn);
  const pageInfo = document.createElement('span');
  pageInfo.className = 'pagination-info';
  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  paginationEl.appendChild(pageInfo);
  const nextBtn = document.createElement('button');
  nextBtn.innerHTML = '‚û°Ô∏è';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderMain(); } };
  paginationEl.appendChild(nextBtn);
}
function getPaginatedItems(items) {
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  return items.slice(startIndex, endIndex);
}

/* =========================
   Folder Render (with Collapse)
========================= */
function renderFolders(){
  const tree=buildTree('');
  foldersContainer.innerHTML='';
  foldersEmpty.style.display=state.folders.length?'none':'block';
  tree.forEach(n=>appendFolderHeader(n,true,foldersContainer));
}
function appendFolderHeader(node,isRoot,host){
  const section=document.createElement('div');
  section.className='folder-section'+(state.activeFolderId===node.id?' active':'');

  const header=document.createElement('div');
  header.className='folder-header';
  header.dataset.id=node.id;
  header.draggable = true;

  const left=document.createElement('div'); left.className='folder-left';

  // Collapse toggle
  const toggle=document.createElement('span');
  toggle.className='toggle-icon';
  const isCollapsed = !!state.collapse[node.id];
  toggle.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';
  toggle.title = isCollapsed ? 'Expand' : 'Collapse';
  toggle.onclick=(e)=>{
    e.stopPropagation();
    state.collapse[node.id]=!isCollapsed;
    save(); renderFolders();
  };

  // Title + count
  const title=document.createElement('span'); title.className='folder-title'; title.textContent='ü¶à '+node.name;
  const count=document.createElement('span'); count.className='folder-count'; 
  const subfolderCount = immediateFolderCount(node.id);
  count.textContent = `(${subfolderCount} folder${subfolderCount !== 1 ? 's' : ''})`;
  left.append(toggle,title,count);

  const actions=document.createElement('div'); actions.className='folder-actions';
  const menu=document.createElement('div'); menu.className='folder-menu';
  const menuBtn=document.createElement('button'); menuBtn.className='folder-menu-btn'; menuBtn.textContent='‚ãÆ';
  menuBtn.title='Folder options';
  menuBtn.onclick=(e)=>{
    e.stopPropagation();
    menu.classList.toggle('show');
    document.querySelectorAll('.folder-menu').forEach(m=>{ if(m!==menu) m.classList.remove('show'); });
  };
  const menuBox=document.createElement('div'); menuBox.className='folder-menu-content';

  const addSub=document.createElement('button'); addSub.textContent='‚ûï Subfolder';
  addSub.onclick=e=>{
    e.stopPropagation();
    menu.classList.remove('show');
    const name=prompt('Subfolder name?');
    if(!name||!name.trim()) return;
    const f={id:uid('fld'),name:name.trim(),parentId:node.id};
    state.folders.push(f); save(); renderFolders();
  };

  const ren=document.createElement('button'); ren.textContent='‚úèÔ∏è Rename';
  ren.onclick=e=>{
    e.stopPropagation();
    menu.classList.remove('show');
    const name=prompt('Rename folder:',node.name);
    if(!name||!name.trim()) return;
    const f=state.folders.find(x=>x.id===node.id);
    if(f){
      f.name=name.trim(); save(); renderFolders();
      try{ if(state.activeFolderId===node.id && typeof viewLabel!=='undefined') viewLabel.textContent=f.name; }catch(_){}
    }
  };

  const del=document.createElement('button'); del.textContent='üóëÔ∏è Delete';
  del.onclick=e=>{
    e.stopPropagation();
    menu.classList.remove('show');
    if(!confirm('Delete this folder and ALL of its contents?')) return;
    if(typeof deleteFolder==='function'){ deleteFolder(node.id); }
    else { state.folders=state.folders.filter(f=>f.id!==node.id); }
    if(state.activeFolderId===node.id){ state.activeFolderId=''; }
    save(); renderFolders();
    try{ if(typeof renderMain==='function') renderMain(); }catch(_){}
  };

  menuBox.append(addSub,ren,del);
  menu.append(menuBtn,menuBox);
  actions.append(menu);

  header.append(left,actions);
  section.appendChild(header);

  // Folder drag/drop & click
  header.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/folder-id', node.id);
    e.dataTransfer.effectAllowed = 'move';
  });
  header.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect='move'; section.style.outline='2px dashed rgba(255,255,255,0.25)'; });
  header.addEventListener('dragleave', () => { section.style.outline='none'; });
  header.addEventListener('drop', e => {
    e.preventDefault(); section.style.outline='none';
    const draggedFolderId = e.dataTransfer.getData('text/folder-id');
    if (!draggedFolderId) return;
    const draggedFolder = state.folders.find(f => f.id === draggedFolderId);
    if (!draggedFolder) return;
    if (draggedFolderId === node.id) return;
    if (isFolderInChildren(node.id, draggedFolderId)) return;
    draggedFolder.parentId = node.id;
    save(); renderFolders(); renderMain();
    showToast('ü¶à Folder moved');
  });

  header.onclick=(e)=>{
    if (e.target.closest('.folder-menu') || e.target.closest('.folder-menu-btn')) return;
    if (e.dataTransfer) return;
    if (state.activeFolderId) state.folderHistory.push(state.activeFolderId);
    state.activeFolderId = node.id;
    viewLabel.textContent = node.name;
    backBtn.style.display='inline-block';
    backToMain.style.display='inline-block';
    folderTopbarActions.style.display = 'flex';
    renderFolders(); renderMain();
  };

  // Children (respect collapse)
  const hasChildren = node.children && node.children.length;
  if(hasChildren){
    const nest=document.createElement('div'); 
    nest.style.marginLeft='16px';
    if (isCollapsed) nest.style.display='none';
    node.children.forEach(ch=> appendFolderHeader(ch,false,nest));
    section.appendChild(nest);
  }
  host.appendChild(section);
}
function isFolderInChildren(parentId, checkId) {
  const children = state.folders.filter(f => f.parentId === parentId);
  for (const child of children) {
    if (child.id === checkId) return true;
    if (isFolderInChildren(child.id, checkId)) return true;
  }
  return false;
}
function deleteFolder(id){
  state.folders.filter(f=>f.parentId===id).forEach(ch=>deleteFolder(ch.id));
  for(const m of Object.values(state.media)){ if(m.folderId===id){ delete state.media[m.id]; } }
  state.folders=state.folders.filter(f=>f.id!==id);
}

/* =========================
   Main grid render (with folders)
========================= */
let _currentList = [];
async function renderMain(){
  const all=Object.values(state.media||{});
  const inFolder = !!state.activeFolderId;
  const currentFolders = state.folders.filter(f => inFolder ? (f.parentId||'') === state.activeFolderId : !(f.parentId));
  const filteredMedia=all.filter(m=> inFolder ? (m.folderId||'')===state.activeFolderId : !(m.folderId)).sort(sorter());
  const allItems = [...currentFolders.map(f => ({...f, type: 'folder'})), ...filteredMedia];
  _currentList = allItems;

  const paginatedItems = getPaginatedItems(allItems);
  mainList.innerHTML='';
  if(!allItems.length){ 
    mainEmpty.style.display='flex'; 
    mainList.style.display='none'; 
    paginationEl.style.display = 'none';
    return; 
  }
  mainEmpty.style.display='none'; 
  mainList.style.display='flex';
  for(const item of paginatedItems){ 
    if (item.type === 'folder') mainList.appendChild(await renderFolderItem(item));
    else mainList.appendChild(await renderItem(item));
  }
  renderPagination(allItems.length);
}

async function renderFolderItem(folder) {
  const el = document.createElement('div');
  el.className = 'vitem';
  el.draggable = true;
  el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/folder-id', folder.id); });

  const th = document.createElement('div');
  th.className = 'thumb';
  th.style.display = 'flex'; th.style.alignItems = 'center'; th.style.justifyContent = 'center'; th.style.fontSize = '48px';
  th.textContent = 'ü¶à';

  const meta = document.createElement('div');
  const h = document.createElement('h4'); 
  h.textContent = folder.name || '(untitled folder)';
  const badge = document.createElement('span'); 
  badge.className = 'badge'; badge.textContent = 'FOLDER';
  h.appendChild(badge); 
  meta.appendChild(h);

  const count = document.createElement('div');
  count.className = 'small';
  const totalItems = folderCount(folder.id);
  count.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
  meta.appendChild(count);

  const actions = document.createElement('div'); 
  actions.className = 'item-actions';
  const delBtn = document.createElement('button'); delBtn.className = 'item-btn'; delBtn.title = 'Delete'; delBtn.textContent = 'üóëÔ∏è';
  delBtn.onclick = async (e) => {
    e.stopPropagation();
    if(!confirm('Delete folder "' + (folder.name || '(untitled)') + '" and ALL contents?')) return;
    deleteFolder(folder.id);
    if(state.activeFolderId === folder.id) {
      state.activeFolderId = '';
      backToMain.style.display = 'none';
      backBtn.style.display = 'none';
      folderTopbarActions.style.display = 'none';
    }
    save(); renderFolders(); renderMain();
  };
  actions.append(delBtn);

  el.append(th, meta, actions);
  el.onclick = () => {
    currentPage = 1;
    if (state.activeFolderId) state.folderHistory.push(state.activeFolderId);
    state.activeFolderId = folder.id;
    viewLabel.textContent = folder.name;
    backBtn.style.display = 'inline-block';
    backToMain.style.display = 'inline-block';
    folderTopbarActions.style.display = 'flex';
    renderFolders(); renderMain();
  };
  return el;
}

async function renderItem(m){
  const el=document.createElement('div');
  el.className='vitem';
  el.draggable=true;
  el.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/id',m.id); });

  const th=document.createElement('div'); th.className='thumb';
  const blob=await dbGet(m.dbKey);
  if(blob){
    const url=URL.createObjectURL(blob);
    if(m.type==='photo'){ const i=new Image(); i.src=url; th.appendChild(i); }
    else { const v=document.createElement('video'); v.src=url; v.muted=true; v.playsInline=true; th.appendChild(v); }
  }else{
    const p=document.createElement('div'); p.textContent='(missing)'; th.appendChild(p);
  }

  const meta=document.createElement('div');
  const h=document.createElement('h4'); h.textContent=m.name||'(untitled)';
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=(m.type||'').toUpperCase();
  h.appendChild(badge); meta.appendChild(h);

  const actions=document.createElement('div'); actions.className='item-actions';
  const renBtn=document.createElement('button'); renBtn.className='item-btn'; renBtn.title='Rename'; renBtn.textContent='‚úèÔ∏è';
  renBtn.onclick=(e)=>{
    e.stopPropagation();
    const newName=prompt('Rename file:',m.name);
    if(!newName)return;
    let finalName=newName.trim();
    if(!finalName.toLowerCase().endsWith(m.type==='photo'?'.jpg':'.mp4')) finalName+=(m.type==='photo'?'.jpg':'.mp4');
    m.name=finalName; save(); renderFolders(); renderMain();
  };
  const delBtn=document.createElement('button'); delBtn.className='item-btn'; delBtn.title='Delete'; delBtn.textContent='üóëÔ∏è';
  delBtn.onclick=async (e)=>{
    e.stopPropagation();
    if(!confirm('Delete "'+(m.name||'(untitled)')+'"?')) return;
    await dbDel(m.dbKey); delete state.media[m.id]; save(); renderFolders(); renderMain();
  };
  actions.append(renBtn,delBtn);

  el.append(th,meta,actions);
  el.onclick=()=>openViewer(m);
  return el;
}

/* =========================
   Viewer
========================= */
let _currentIndex = -1;
let _currentObjectUrl = null;
let _currentImgUrl = null;

function hideBothMedia(){ viewerVideo.pause(); viewerVideo.src=''; viewerVideo.style.display='none'; viewerImage.style.display='none'; }
function revokeCurrentUrls(){ if(_currentObjectUrl){ try{URL.revokeObjectURL(_currentObjectUrl);}catch(e){} _currentObjectUrl=null; } if(_currentImgUrl){ try{URL.revokeObjectURL(_currentImgUrl);}catch(e){} _currentImgUrl=null; } }

async function openViewer(m){
  _currentIndex = _currentList.findIndex(x=>x.id===m.id);
  state.viewerCurrent = m.id; save();
  const blob=await dbGet(m.dbKey); if(!blob) return;
  revokeCurrentUrls(); hideBothMedia();
  const url=URL.createObjectURL(blob);
  viewerFilename.textContent=(m.type==='photo'?'üì∑ ':'üéûÔ∏è ')+(m.name||'');
  viewer.classList.add('show'); viewer.setAttribute('aria-hidden','false');
  if(m.type==='photo'){ _currentImgUrl = url; viewerImage.src = url; viewerImage.style.display='block'; }
  else { _currentObjectUrl = url; viewerVideo.src = url; viewerVideo.style.display='block'; try{ await viewerVideo.play(); }catch{} }
}
function navigate(offset){
  if(_currentIndex<0) return;
  const next = _currentIndex + offset;
  if(next<0 || next>=_currentList.length){ showToast('‚õî Start/end of list'); return; }
  let checkIndex = next;
  while (checkIndex >= 0 && checkIndex < _currentList.length) {
    if (_currentList[checkIndex].type !== 'folder') { _currentIndex = checkIndex; openViewer(_currentList[_currentIndex]); return; }
    checkIndex += offset;
  }
  showToast('‚õî No media files in this direction');
}
viewerPrev.onclick=()=>navigate(-1);
viewerNext.onclick=()=>navigate(1);
viewerClose.onclick=()=>{ viewer.classList.remove('show'); viewer.setAttribute('aria-hidden','true'); hideBothMedia(); revokeCurrentUrls(); };
viewer.addEventListener('click',e=>{ if(e.target===viewer) viewerClose.click(); });
document.addEventListener('keydown',(e)=>{
  if(viewer.getAttribute('aria-hidden')==='false'){
    if(e.key==='ArrowRight') navigate(1);
    else if(e.key==='ArrowLeft') navigate(-1);
    else if(e.key==='Escape') viewerClose.click();
  }
});

/* =========================
   Buttons & Uploads
========================= */
addFolderBtn.onclick=()=>{
  const n=(newFolderName.value||'').trim(); if(!n) return;
  const f={id:uid('fld'),name:n,parentId:state.activeFolderId||''}; state.folders.push(f); save(); newFolderName.value=''; renderFolders(); renderMain();
};
function handleVideoUpload(e) {
  for(const f of Array.from(e.target.files||[])){
    const id=uid('vid'); 
    dbPut(id,f);
    state.media[id]={id,name:f.name,type:'video',dbKey:id,createdAt:Date.now(),folderId:state.activeFolderId||''};
  }
  save(); renderFolders(); renderMain(); 
  videoInput.value='';
  showToast('‚úÖ Videos added to library');
}
function handlePhotoUpload(e) {
  for(const f of Array.from(e.target.files||[])){
    const id=uid('img'); 
    dbPut(id,f);
    state.media[id]={id,name:f.name,type:'photo',dbKey:id,createdAt:Date.now(),folderId:state.activeFolderId||''};
  }
  save(); renderFolders(); renderMain(); 
  photoInput.value='';
  showToast('‚úÖ Photos added to library');
}
addVideosTopbar.onclick=()=> videoInput.click();
addPhotosTopbar.onclick=()=> photoInput.click();
videoInput.onchange = handleVideoUpload;
photoInput.onchange = handlePhotoUpload;

backToMain.onclick=()=>{ 
  state.activeFolderId=''; 
  state.folderHistory = [];
  currentPage = 1;
  backToMain.style.display='none'; 
  backBtn.style.display='none';
  folderTopbarActions.style.display = 'none';
  viewLabel.textContent='Main Library'; 
  renderFolders(); 
  renderMain(); 
};
backBtn.onclick = () => {
  if (state.folderHistory.length > 0) {
    const previousFolderId = state.folderHistory.pop();
    state.activeFolderId = previousFolderId;
    currentPage = 1;
    const previousFolder = state.folders.find(f => f.id === previousFolderId);
    if (previousFolder) viewLabel.textContent = previousFolder.name;
    if (state.folderHistory.length === 0) backBtn.style.display = 'none';
  } else {
    state.activeFolderId = '';
    backBtn.style.display = 'none';
    backToMain.style.display = 'none';
    folderTopbarActions.style.display = 'none';
    viewLabel.textContent = 'Main Library';
  }
  renderFolders(); renderMain();
};

/* =========================
   Folder Action Buttons
========================= */
folderRemoveBtn.onclick = () => {
  if (!state.activeFolderId) return;
  const folder = state.folders.find(f => f.id === state.activeFolderId); if (!folder) return;
  if(!confirm('Delete folder "' + (folder.name || '(untitled)') + '" and ALL contents?')) return;
  deleteFolder(folder.id);
  state.activeFolderId = '';
  backToMain.style.display = 'none';
  backBtn.style.display = 'none';
  folderTopbarActions.style.display = 'none';
  viewLabel.textContent = 'Main Library';
  save(); renderFolders(); renderMain();
};
folderRenameBtn.onclick = () => {
  if (!state.activeFolderId) return;
  const folder = state.folders.find(f => f.id === state.activeFolderId); if (!folder) return;
  const name=prompt('Rename folder:',folder.name);
  if(!name||!name.trim()) return;
  folder.name=name.trim(); 
  viewLabel.textContent = folder.name;
  save(); renderFolders(); renderMain();
};
folderSubfolderBtn.onclick = () => {
  if (!state.activeFolderId) return;
  const name=prompt('Subfolder name?');
  if(!name||!name.trim()) return;
  const f={id:uid('fld'),name:name.trim(),parentId:state.activeFolderId};
  state.folders.push(f); 
  save(); renderFolders(); renderMain();
};

/* Drag to main grid root (remove from folder) */
mainList.addEventListener('dragover',e=>{ e.preventDefault(); mainList.style.outline='2px dashed rgba(255,255,255,0.25)'; });
mainList.addEventListener('dragleave',()=>{ mainList.style.outline='none'; });
mainList.addEventListener('drop',e=>{
  e.preventDefault(); mainList.style.outline='none';
  const folderId = e.dataTransfer.getData('text/folder-id');
  if (folderId) {
    const folder = state.folders.find(f => f.id === folderId);
    if (folder) {
      folder.parentId = '';
      save(); renderFolders(); renderMain();
      return;
    }
  }
  const id=e.dataTransfer.getData('text/id'); 
  if(!id) return;
  const m=state.media[id]; if(!m) return;
  if(state.activeFolderId){ return; } // only allow drop to root when viewing Main Library
  m.folderId=''; save(); renderFolders(); renderMain();
});

/* =========================
   Import/Export
========================= */
class ZipStoreWriter {
  constructor() { this.files = []; this.encoder = new TextEncoder(); this.size = 0; }
  _dosDateTime(date=new Date()) {
    const year = date.getFullYear();
    const dosTime = ((date.getHours() & 0x1F) << 11) | ((date.getMinutes() & 0x3F) << 5) | ((Math.floor(date.getSeconds()/2)) & 0x1F);
    const dosDate = (((year - 1980) & 0x7F) << 9) | (((date.getMonth()+1) & 0x0F) << 5) | (date.getDate() & 0x1F);
    return {dosTime, dosDate};
  }
  async addFile(path, blob) {
    const nameBytes = this.encoder.encode(path.replace(/^\/+/, ""));
    const {dosTime,dosDate} = this._dosDateTime(new Date());
    const crc = await this._crc32Blob(blob);
    const size = blob.size;
    const localHeader = new DataView(new ArrayBuffer(30));
    let p = 0;
    localHeader.setUint32(p, 0x04034b50, true); p+=4;
    localHeader.setUint16(p, 20, true); p+=2;
    localHeader.setUint16(p, 0, true); p+=2;
    localHeader.setUint16(p, 0, true); p+=2;
    localHeader.setUint16(p, dosTime, true); p+=2;
    localHeader.setUint16(p, dosDate, true); p+=2;
    localHeader.setUint32(p, crc>>>0, true); p+=4;
    localHeader.setUint32(p, size, true); p+=4;
    localHeader.setUint32(p, size, true); p+=4;
    localHeader.setUint16(p, nameBytes.length, true); p+=2;
    localHeader.setUint16(p, 0, true); p+=2;
    const localHeaderBlob = new Blob([localHeader, nameBytes, blob]);
    const localHeaderSize = 30 + nameBytes.length;
    const localFileHeaderOffset = this.size;
    this.size += localHeaderSize + size;

    const cdHeader = new DataView(new ArrayBuffer(46));
    p = 0;
    cdHeader.setUint32(p, 0x02014b50, true); p+=4;
    cdHeader.setUint16(p, 20, true); p+=2;
    cdHeader.setUint16(p, 20, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint16(p, dosTime, true); p+=2;
    cdHeader.setUint16(p, dosDate, true); p+=2;
    cdHeader.setUint32(p, crc>>>0, true); p+=4;
    cdHeader.setUint32(p, size, true); p+=4;
    cdHeader.setUint32(p, size, true); p+=4;
    cdHeader.setUint16(p, nameBytes.length, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint16(p, 0, true); p+=2;
    cdHeader.setUint32(p, localFileHeaderOffset, true); p+=4;

    this.files.push({ local:new Blob([localHeader, nameBytes, blob]), central:new Blob([cdHeader, nameBytes]) });
  }
  async _crc32Blob(blob) {
    const table = ZipStoreWriter._crcTable || (ZipStoreWriter._crcTable = (()=>{
      let c, table = new Uint32Array(256);
      for (let n=0;n<256;n++){
        c = n;
        for (let k=0;k<8;k++){ c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1); }
        table[n] = c >>> 0;
      }
      return table;
    })());
    let crc = 0 ^ (-1);
    const reader = blob.stream().getReader();
    while (true) {
      const {value, done} = await reader.read();
      if (done) break;
      const arr = new Uint8Array(value);
      for (let i=0;i<arr.length;i++){ crc = (crc >>> 8) ^ table[(crc ^ arr[i]) & 0xFF]; }
    }
    return (crc ^ (-1)) >>> 0;
  }
  async build(filename="BeamMediaArchive_Backup.zip") {
    const localParts = this.files.map(f=>f.local);
    const centralParts = this.files.map(f=>f.central);
    const centralSize = (await new Blob(centralParts).arrayBuffer()).byteLength;
    const centralOffset = this.size;
    const end = new DataView(new ArrayBuffer(22));
    let p=0;
    end.setUint32(p, 0x06054b50, true); p+=4;
    end.setUint16(p, 0, true); p+=2;
    end.setUint16(p, 0, true); p+=2;
    end.setUint16(p, this.files.length, true); p+=2;
    end.setUint16(p, this.files.length, true); p+=2;
    end.setUint32(p, centralSize, true); p+=4;
    end.setUint32(p, centralOffset, true); p+=4;
    end.setUint16(p, 0, true); p+=2;
    const zipBlob = new Blob([ ...localParts, ...centralParts, end ], {type: 'application/zip'});
    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
}
function buildFolderPathMap() {
  const byId = Object.fromEntries(state.folders.map(f=>[f.id, f]));
  const cache = {};
  function pathFor(id){
    if(!id) return "";
    if(cache[id]) return cache[id];
    const node = byId[id];
    if(!node) return "";
    const parentPath = pathFor(node.parentId||"");
    const p = (parentPath ? (parentPath + "/") : "") + node.name;
    return cache[id]=p;
  }
  return pathFor;
}
async function exportLibraryZip(){
  try {
    showToast('‚è≥ Preparing export...');
    const writer = new ZipStoreWriter();
    const pathFor = buildFolderPathMap();
    const meta = JSON.stringify({ state }, null, 2);
    await writer.addFile("metadata.json", new Blob([meta], {type:"application/json"}));
    const items = Object.values(state.media||{});
    for (const m of items){
      const blob = await dbGet(m.dbKey);
      if(!blob) continue;
      const folderPath = pathFor(m.folderId||"");
      const basePath = folderPath || "Main Library";
      const fpath = (basePath ? basePath + "/" : "") + (m.name || (m.type==='photo'?'image.jpg':'video.mp4'));
      await writer.addFile(fpath, blob);
    }
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    await writer.build(`BeamMediaArchive_Backup_${stamp}.zip`);
    showToast('‚úÖ Library exported successfully');
  } catch (e){ console.error(e); alert('Export failed.'); }
}
async function importLibraryFolder(fileList){
  try{
    showToast('‚è≥ Importing folder...');
    const files = Array.from(fileList||[]);
    if(!files.length){ alert('No folder selected'); return; }
    const metaEntry = files.find(f=>/(^|\/)metadata\.json$/i.test(f.webkitRelativePath || f.name));
    let meta = null;
    if(metaEntry){ try{ meta = JSON.parse(await metaEntry.text()); }catch(e){ console.warn('metadata.json parse failed', e); } }
    const folderIdByPath = new Map();
    function ensureFolder(path){
      path = path.replace(/^\/+|\/+$/g,'');
      if(!path) return '';
      if(folderIdByPath.has(path)) return folderIdByPath.get(path);
      const parts = path.split('/');
      let curPath = '';
      let parentId = '';
      for(const part of parts){
        curPath = curPath ? (curPath + '/' + part) : part;
        if(folderIdByPath.has(curPath)){ parentId = folderIdByPath.get(curPath); continue; }
        if (part === 'Main Library' && curPath === 'Main Library'){ folderIdByPath.set(curPath, ''); parentId=''; continue; }
        const f = {id:uid('fld'), name:part, parentId};
        state.folders.push(f);
        folderIdByPath.set(curPath, f.id);
        parentId = f.id;
      }
      return folderIdByPath.get(path);
    }
    const mediaRe = /\.(mp4|webm|mov|m4v|jpg|jpeg|png|gif)$/i;
    let imported = 0;
    for(const f of files){
      const rel = (f.webkitRelativePath || f.name);
      if (/metadata\.json$/i.test(rel)) continue;
      if (!mediaRe.test(rel)) continue;
      const parts = rel.split('/'); parts.pop();
      const folderPath = parts.join('/');
      const folderId = ensureFolder(folderPath);
      const blob = f;
      const id = /\.(jpg|jpeg|png|gif)$/i.test(rel) ? uid('img') : uid('vid');
      await dbPut(id, blob);
      state.media[id] = {
        id, name: f.name,
        type: /\.(jpg|jpeg|png|gif)$/i.test(f.name) ? 'photo' : 'video',
        dbKey: id, createdAt: Date.now(), folderId: folderId || ''
      };
      imported++;
    }
    save(); renderFolders(); renderMain();
    showToast(`‚úÖ Imported ${imported} file(s)`);
  }catch(e){ console.error(e); alert('Import failed.'); }
}
const exportBtn = document.getElementById('exportLibrary');
const importBtn = document.getElementById('importLibrary');
const importFolderInput = document.getElementById('importFolderInput');
if (exportBtn) exportBtn.onclick = exportLibraryZip;
if (importBtn) importBtn.onclick = ()=> importFolderInput.click();
if (importFolderInput) importFolderInput.onchange = (e)=>{ importLibraryFolder(e.target.files); importFolderInput.value = ''; };

/* =========================
   Initial render
========================= */
renderFolders(); renderMain();
if (state.activeFolderId) {
  backBtn.style.display = 'inline-block';
  backToMain.style.display = 'inline-block';
  folderTopbarActions.style.display = 'flex';
}
document.addEventListener('click', (ev)=>{
  document.querySelectorAll('.folder-menu.show').forEach(m=>{ if(!m.contains(ev.target)) m.classList.remove('show'); });
});

/* =========================
   MOBILE: nav wiring
========================= */
const mNav = document.getElementById('mobileNav');
const addSheet = document.getElementById('addSheet');
const mHome = document.getElementById('mHome');
const mFolders = document.getElementById('mFolders');
const mAdd = document.getElementById('mAdd');
const mImport = document.getElementById('mImport');
const mExport = document.getElementById('mExport');
const mAddVideo = document.getElementById('mAddVideo');
const mAddPhoto = document.getElementById('mAddPhoto');
const mNewFolder = document.getElementById('mNewFolder');

function isMobile(){ return window.matchMedia('(max-width: 768px)').matches; }
function showSheet(show){
  addSheet.style.display='block';
  requestAnimationFrame(()=> addSheet.classList.toggle('show', !!show));
  if(!show){ setTimeout(()=>{ addSheet.style.display='none'; }, 260); }
}
function ensureNav(){
  if(isMobile()){ mNav.style.display='flex'; } else {
    mNav.style.display='none';
    showSheet(false);
  }
}
ensureNav();
window.addEventListener('resize', ensureNav);

// Buttons -> reuse existing logic
mHome.addEventListener('click', ()=> { backToMain.click(); });
mFolders.addEventListener('click', ()=>{
  // jump to sidebar area
  document.querySelector('.sidebar')?.scrollIntoView({behavior:'smooth', block:'start'});
  showToast('üóÇÔ∏è Folders below');
});
mAdd.addEventListener('click', ()=> showSheet(!addSheet.classList.contains('show')));
mImport.addEventListener('click', ()=> { document.getElementById('importLibrary').click(); });
mExport.addEventListener('click', ()=> { document.getElementById('exportLibrary').click(); });

mAddVideo.addEventListener('click', ()=>{ showSheet(false); addVideosTopbar.click(); });
mAddPhoto.addEventListener('click', ()=>{ showSheet(false); addPhotosTopbar.click(); });
mNewFolder.addEventListener('click', ()=>{
  showSheet(false);
  const n = prompt('New folder name?'); if(!n||!n.trim()) return;
  const f = {id:uid('fld'), name:n.trim(), parentId:state.activeFolderId||''};
  state.folders.push(f); save(); renderFolders(); renderMain(); showToast('ü¶à Folder created');
});

// Hide sheet if user taps backdrop area near the nav
document.addEventListener('click', (e)=>{
  if(!isMobile()) return;
  if(addSheet.classList.contains('show') && !e.target.closest('#addSheet') && !e.target.closest('#mAdd')){
    showSheet(false);
  }
});
</script>
</body>
</html>
